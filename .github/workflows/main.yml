name: CI/CD for Next.js (Cloudflare Pages)

# 1. Triggers (Equivalent to GitLab 'rules' on a global level)
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch: # Allows manual trigger

# 2. Define Variables and Environment
env:
  NODE_VERSION: 20

# 3. Define Jobs (Equivalent to GitLab stages and jobs)
jobs:
  # --- CI STAGE: BUILD ---
  build:
    name: Build Project
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Set up Node.js with a specific version
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm' # Configures npm cache

      # Install dependencies (npm ci for clean install) and run build
      - name: Install Dependencies and Build
        run: |
          npm ci
          npm run build

      # Save the build artifacts (.next/ and dist/ folder) for later jobs
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: .next/ # Assuming 'npm run build' generates the files in .next/

  # --- CI STAGE: LINT (Can run in parallel with build, or depend on it) ---
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    # This job can run at the same time as build
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: Install Dependencies and Run Lint
        run: |
          npm ci
          npm run lint # Assumes lint is defined in package.json
    # Only run lint on main/develop branch pushes or PRs targeting them
    if: |
      github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') || 
      github.event_name == 'pull_request' && (github.base_ref == 'main' || github.base_ref == 'develop')

  # --- CD STAGE: DEPLOY (Cloudflare Pages) ---
  deploy:
    name: Deploy to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: [build] # Wait for the build job to complete

    steps:
      # Download the artifact created in the 'build' job
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: .

      # Cloudflare Pages deployment action (replaces 'npm install -g wrangler' and 'wrangler pages deploy')
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }} # Secret token for authentication
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }} # Cloudflare Account ID
          projectName: codx-frontend-prod
          directory: . # The directory containing the .next/ and other built files

      # Conditional Deployment Rules (Translating your GitLab rules)
      - name: Set Deployment Branch
        id: branch_name
        run: |
          if [ "${{ github.ref_name }}" == "develop" ]; then
            echo "branch=develop" >> $GITHUB_OUTPUT
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "manual_deploy=false" >> $GITHUB_OUTPUT # Can be automated
          elif [ "${{ github.ref_name }}" == "main" ]; then
            echo "branch=main" >> $GITHUB_OUTPUT
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "manual_deploy=true" >> $GITHUB_OUTPUT # Manual trigger for production
          fi

    # Conditional deployment based on branch (GitHub Actions handles manual deployments differently)
    environment:
      name: ${{ steps.branch_name.outputs.environment }}

    # Run only on specific branches
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
